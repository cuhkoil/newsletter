<link rel="import" href="bower_components/polymer/polymer.html">
<!--link rel="import" href="bower_components/post-service/post-service.html"-->
<link rel="import" href="feed-service.html">
<link rel="import" href="event-card.html">

<polymer-element name="event-list" attributes="show url issue">
    <template>

        <link rel="stylesheet" type="text/css" href="bower_components/bootstrap/dist/css/bootstrap.min.css">

        <style>
            :host {
            }
            .event-list {
                margin-bottom: 30px;
            }

            div.issue h2{
                text-align: center;
            }
            div.issue h2 small{
                color: gray;
                font-size: 0.5em;
            }
            div.issue h2 small a{
                color: gray;
            }
            div.issue.published{
                -webkit-box-shadow: 7px 7px 5px 0px rgba(50, 50, 50, 0.75);
                -moz-box-shadow:    7px 7px 5px 0px rgba(50, 50, 50, 0.75);
                box-shadow:         7px 7px 5px 0px rgba(50, 50, 50, 0.75);
                border-top: 2px solid;
                border-left: 2px solid;
                border-top-left-radius: 10px;
            }
            div.issue.preparing{
                -webkit-box-shadow: 7px 7px 5px 0px rgba(235, 155, 255, 0.75);
                -moz-box-shadow:    7px 7px 5px 0px rgba(235, 155, 255, 0.75);
                box-shadow:         7px 7px 5px 0px rgba(235, 155, 255, 0.75);
                border-top: 2px solid rgba(235, 155, 255, 0.75);
                border-left: 2px solid rgba(235, 155, 255, 0.75);
                border-top-left-radius: 10px;
                background-image: url('assets/img/background-preparing.png');
                background-size: 100px;
                background-repeat: no-repeat;
            }

        </style>

        <!-- add markup here -->
        <feed-service id="service" feeds="{{feeds}}" url="{{url}}" callback="{{genCallbackOnFeedsLoaded()}}">
        </feed-service>

        <div id="issue" class="issue {{issue.gsx$status.$t}}">
            <h2>~Issue {{feed.gsx$date.$t}}~
                <br>
                <small>Links:
                    <a href="issue/{{issue.gsx$id.$t}}.html">[HTML]</a>
                    <a href="{{issue.gsx$editurl.$t}}">[GDoc]</a>
                </small>
            </h2>
            <div class="event-list" horizontal layout wrap>
                <template repeat="{{feed in feeds}}">
                    <event-card>
                        <h2>{{feed.gsx$title.$t}}</h2>
                        <h3>{{feed.gsx$timestart.$t}} - {{feed.gsx$timeend.$t}}</h3>
                        <h3>{{feed.gsx$venue.$t}}</h3>
                        <h3>organized by {{feed.gsx$organizer.$t}}</h3>
                        <p>{{feed.gsx$description.$t}}</p>
                        <a class="btn btn-default" href="{{feed.gsx$link.$t}}">Read more --></a>
                    </event-card>
                </template>
            </div>
        </div>


    </template>

    <script>
        // This does not work because here "this" will be the window.
        // The current Polymer element "this" is created later.
        // var me = this;
        Polymer('event-list',{
            genCallbackOnFeedsLoaded: function(){
                var me = this;
                var callbackOnFeedsLoaded = function(feeds){
                    // "this" will be the following one if called from another element:
                    // <feed-service id=​"service" feeds=​"{{feeds}​}​" url=​"{{url}​}​" callback=​"{{callbackOnFeedsLoaded}​}​">​…​</feed-service>​ event-list.html:86
                    // Using the following way, you are getting a DOM element,
                    // instead of a Polymer element.
                    // var me = this.parentNode;
                    console.log('even-list loaded. Trigger redraw');
                    setTimeout(function(){
                        console.log('time out');
//                        console.log(me);
//                        console.log(this);
                        var issue = me.$.issue; //document.getElementById('issue');
                        //issue.setAttribute('display', 'none');
                        var parent = issue.parentNode;
                        // A small hack: this triggers the redraw of the "issue" element.
                        // Note that we load feeds asynchronously.
                        // Immediately after the model is changed, Polymer will redraw part of the box,
                        // resulting in a fragmented view.
                        // This triggers the redraw of the whole issue box.
                        parent.removeChild(issue);
                        parent.appendChild(issue);
                        //issue.removeAttribute('display');
                    }, 200);
                }
                return callbackOnFeedsLoaded;
            }
        });
    </script>

</polymer-element>
